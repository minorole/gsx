#!/usr/bin/env zsh

set -eu
set -o pipefail 2>/dev/null || true

# gpane - Ghostty Session Manager
# https://github.com/minorole/gsx
# (formerly known as gsx)

GPANE_ROOT="${0:A:h:h}"

# Source modules
source "${GPANE_ROOT}/lib/core.zsh"
source "${GPANE_ROOT}/lib/input.zsh"
source "${GPANE_ROOT}/lib/update.zsh"
source "${GPANE_ROOT}/lib/help.zsh"
source "${GPANE_ROOT}/lib/config.zsh"
source "${GPANE_ROOT}/lib/projects.zsh"
source "${GPANE_ROOT}/lib/layouts.zsh"
source "${GPANE_ROOT}/lib/prompts.zsh"
source "${GPANE_ROOT}/lib/setup.zsh"

# Global flags
DRY_RUN=false
REUSE_WINDOW=false

# Open session for a project
# Sets PROJECT_LAYOUT as side effect (for caller to use in header)
open_session() {
  local project_dir=$1
  local reuse_window=${2:-false}
  local project_name=$(basename "${project_dir}")

  parse_config
  parse_project_config "${project_name}"

  # Resolve layout alias to row notation
  local resolved_layout
  resolved_layout=$(resolve_layout_alias "${DEFAULT_LAYOUT}")
  PROJECT_LAYOUT="${resolved_layout}"

  if [[ "${DRY_RUN}" == true ]]; then
    local window_mode="new"
    [[ "${reuse_window}" == "true" ]] && window_mode="current"
    echo "  ${project_name}"
    echo "    dir:    ${project_dir}"

    local panes_per_tab
    panes_per_tab=$(compute_total_panes "${resolved_layout}")

    if (( TABS_COUNT > 1 )); then
      echo "    layout: ${resolved_layout} Ã— ${TABS_COUNT} tabs (${panes_per_tab} panes/tab)"
    else
      echo "    layout: ${resolved_layout}"
    fi
    echo "    window: ${window_mode}"

    if (( TABS_COUNT > 1 )); then
      # Tabs + panes mode
      local cmd_idx=1
      for ((t = 1; t <= TABS_COUNT; t++)); do
        echo "    tab ${t}/${TABS_COUNT}:"
        for ((p = 1; p <= panes_per_tab; p++)); do
          local cmd="${PANE_COMMANDS[$cmd_idx]:-}"
          echo "      pane ${p}: ${cmd:-<empty>}"
          cmd_idx=$((cmd_idx + 1))
        done
      done
    else
      # Single window with panes
      for ((i = 1; i <= panes_per_tab; i++)); do
        local cmd="${PANE_COMMANDS[$i]:-}"
        echo "    pane $i: ${cmd:-<empty>}"
      done
    fi
    return 0
  fi

  # Check for deprecated layout: tabs syntax
  if ! check_deprecated_tabs_layout "${resolved_layout}"; then
    return 1
  fi

  # Route to appropriate layout handler
  if (( TABS_COUNT > 1 )); then
    layout_hybrid "${project_name}" "${project_dir}" "${resolved_layout}" "${TABS_COUNT}" "${reuse_window}" "${PANE_COMMANDS[@]}"
  else
    layout_dynamic "${project_name}" "${project_dir}" "${resolved_layout}" "${reuse_window}" "${PANE_COMMANDS[@]}"
  fi
}

# Main entry point
main() {
  local cmd="${1:-}"

  # Check for flags anywhere in args
  for arg in "$@"; do
    [[ "${arg}" == "--dry-run" ]] && DRY_RUN=true
    [[ "${arg}" == "--here" || "${arg}" == "--current-window" ]] && REUSE_WINDOW=true
  done

  # Skip preflight for help/version
  case "${cmd}" in
    help|--help|-h|version|--version|-v) ;;
    *) preflight_check ;;
  esac

  case "${cmd}" in
    help|--help|-h)
      show_help
      ;;
    version|--version|-v)
      echo "gpane v${GPANE_VERSION}"
      ;;
    setup)
      if [[ -n "${2:-}" && "${2}" != "--dry-run" ]]; then
        setup_project "$2"
      else
        setup_wizard
      fi
      ;;
    config)
      show_config
      ;;
    list)
      config_exists || { echo "Run 'gpane setup' first."; exit 1; }
      parse_config
      list_projects
      ;;
    uninstall)
      do_uninstall
      ;;
    ""|--dry-run|--here|--current-window)
      if ! config_exists; then
        echo "Welcome to gpane! Let's set it up."
        setup_wizard
      else
        check_for_updates
        [[ "${DRY_RUN}" == false ]] && check_ghostty
        parse_config
        interactive_select || exit 1

        local count=${#SELECTED_PROJECTS[@]}
        if [[ "${DRY_RUN}" == true ]]; then
          echo ""
          echo "[dry-run] Would open ${count} project(s):"
        else
          echo ""
          echo "Opening ${count} project(s)..."
        fi

        local is_first=true
        for dir in "${SELECTED_PROJECTS[@]}"; do
          local should_reuse="false"
          [[ "${REUSE_WINDOW}" == true && "${is_first}" == true ]] && should_reuse="true"
          open_session "${dir}" "${should_reuse}"
          is_first=false
        done

        if [[ "${DRY_RUN}" == false ]]; then
          echo ""
          echo "You can close this terminal."
        fi
      fi
      ;;
    *)
      config_exists || { echo "Run 'gpane setup' first."; exit 1; }
      check_for_updates
      [[ "${DRY_RUN}" == false ]] && check_ghostty
      parse_config
      local project_dir
      project_dir=$(resolve_project_dir "${cmd}") || exit 1

      if [[ "${DRY_RUN}" == true ]]; then
        echo ""
        echo "[dry-run] Would open:"
      else
        echo ""
        echo "Opening..."
      fi

      local should_reuse="false"
      [[ "${REUSE_WINDOW}" == true ]] && should_reuse="true"
      open_session "${project_dir}" "${should_reuse}"

      if [[ "${DRY_RUN}" == false ]]; then
        echo ""
        echo "You can close this terminal."
      fi
      ;;
  esac
}

main "$@"
